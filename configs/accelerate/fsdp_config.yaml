# configs/accelerate/fsdp_config.yaml
# FSDP (Fully Sharded Data Parallel) 配置文件
# 用于 Accelerator 的 FSDP 策略

# ============================================================================
# FSDP 分片策略
# ============================================================================
fsdp_sharding_strategy: "FULL_SHARD"  # 可选:
                                       # - "FULL_SHARD": 完全分片 (ZeRO-3 等价)
                                       # - "SHARD_GRAD_OP": 只分片梯度和优化器状态 (ZeRO-2 等价)
                                       # - "NO_SHARD": 不分片 (DDP 等价)
                                       # - "HYBRID_SHARD": 混合分片 (节点内 FULL_SHARD，节点间 DDP)

# ============================================================================
# CPU Offload 配置
# ============================================================================
fsdp_offload_params: false            # 是否将参数 offload 到 CPU（大模型节省显存）
fsdp_cpu_ram_efficient_loading: true  # CPU 高效加载模式

# ============================================================================
# 自动封装策略
# ============================================================================
fsdp_auto_wrap_policy: "TRANSFORMER_BASED_WRAP"  # 可选:
                                                  # - "NO_WRAP": 不自动封装
                                                  # - "TRANSFORMER_BASED_WRAP": 按 Transformer 层封装
                                                  # - "SIZE_BASED_WRAP": 按参数大小封装

fsdp_transformer_layer_cls_to_wrap: null  # 要封装的 Transformer 层类名列表
                                           # 例如: ["Qwen3OmniMoeDecoderLayer"]
                                           # null 时自动检测

fsdp_min_num_params: 100000000         # SIZE_BASED_WRAP 时，最小参数量阈值 (100M)

# ============================================================================
# 状态字典配置 (用于 checkpoint)
# ============================================================================
fsdp_state_dict_type: "SHARDED_STATE_DICT"  # 可选:
                                             # - "FULL_STATE_DICT": 完整状态字典 (需要大内存)
                                             # - "SHARDED_STATE_DICT": 分片状态字典 (推荐)
                                             # - "LOCAL_STATE_DICT": 本地状态字典

# ============================================================================
# 前向预取 & 后向预取
# ============================================================================
fsdp_forward_prefetch: true           # 前向传播时预取下一层参数
fsdp_backward_prefetch: "BACKWARD_PRE"  # 可选: "BACKWARD_PRE", "BACKWARD_POST", "NO_PREFETCH"

# ============================================================================
# 同步模块状态
# ============================================================================
fsdp_sync_module_states: true         # 初始化时同步模块状态到所有 rank

# ============================================================================
# 混合精度策略
# ============================================================================
fsdp_use_orig_params: true            # 使用原始参数（支持非均匀 dtype）

# ============================================================================
# 激活检查点 (与 FSDP 配合使用)
# ============================================================================
fsdp_activation_checkpointing: false  # FSDP 内置的激活检查点
