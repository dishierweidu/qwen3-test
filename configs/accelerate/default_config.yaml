# configs/accelerate/default_config.yaml
# Accelerate 默认配置文件
# 此文件可用于 `accelerate launch --config_file` 或放置于 ~/.cache/huggingface/accelerate/default_config.yaml
# 通过 `accelerate config` 命令可交互式生成类似配置

# ============================================================================
# 计算环境
# ============================================================================
compute_environment: LOCAL_MACHINE    # 可选: LOCAL_MACHINE, AMAZON_SAGEMAKER, etc.
debug: false

# ============================================================================
# 分布式配置
# ============================================================================
distributed_type: MULTI_GPU           # 可选: NO, MULTI_GPU, DEEPSPEED, FSDP, MEGATRON_LM
num_machines: 1                       # 机器数量
num_processes: 8                      # 总进程数 (所有机器的 GPU 总数)
machine_rank: 0                       # 当前机器的 rank (多机训练时)
main_process_ip: null                 # 主进程 IP (多机训练时)
main_process_port: 29500              # 主进程端口

gpu_ids: all                          # GPU ID 列表，或 "all" 使用所有 GPU
same_network: true                    # 多机是否在同一网络

# ============================================================================
# 混合精度
# ============================================================================
mixed_precision: bf16                 # 可选: no, fp16, bf16
downcast_bf16: 'no'                   # 可选: 'no', 'yes'

# ============================================================================
# DeepSpeed 配置 (仅 distributed_type: DEEPSPEED 时生效)
# ============================================================================
deepspeed_config:
  # 以下配置可以内联写，也可以指定 JSON 文件路径
  # deepspeed_config_file: "configs/deepspeed/zero3_30B.json"
  
  # 或者内联配置
  zero_stage: 3                       # ZeRO 优化阶段: 0, 1, 2, 3
  gradient_accumulation_steps: 8
  gradient_clipping: 1.0
  offload_optimizer_device: none      # 可选: none, cpu, nvme
  offload_param_device: none          # 可选: none, cpu, nvme
  zero3_init_flag: true               # ZeRO-3 初始化标志
  zero3_save_16bit_model: true        # 保存 16-bit 模型权重

# ============================================================================
# FSDP 配置 (仅 distributed_type: FSDP 时生效)
# ============================================================================
fsdp_config:
  fsdp_sharding_strategy: FULL_SHARD            # 分片策略
  fsdp_offload_params: false                    # 参数 offload
  fsdp_auto_wrap_policy: TRANSFORMER_BASED_WRAP # 自动封装策略
  fsdp_backward_prefetch: BACKWARD_PRE          # 后向预取
  fsdp_state_dict_type: SHARDED_STATE_DICT      # 状态字典类型
  fsdp_cpu_ram_efficient_loading: true          # CPU 高效加载
  fsdp_sync_module_states: true                 # 同步模块状态
  fsdp_forward_prefetch: true                   # 前向预取
  fsdp_use_orig_params: true                    # 使用原始参数
  fsdp_activation_checkpointing: false          # 激活检查点

# ============================================================================
# 硬件加速
# ============================================================================
use_cpu: false                        # 是否仅使用 CPU
tpu_use_cluster: false                # TPU 集群模式
tpu_use_sudo: false                   # TPU sudo 模式

# ============================================================================
# RNG 同步
# ============================================================================
rng_types:
  - generator                         # 同步随机数生成器状态
